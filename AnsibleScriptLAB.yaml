---
- hosts: all
  become: yes
  tasks:
    - name: update & upgrade
      apt:
        upgrade: yes
        update_cache: yes

    - name: enable Root Login
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: "PermitRootLogin yes"
        state: present
        backup: yes
      notify:
        - restart ssh

    - name: install iptables
      apt:
        name: iptables
        state: latest
 
    - name: Installer le paquet cowsay
      apt:
        name: cowsay
        state: present

    - name: install php
      apt:
        name: php
        state: latest

    - name: install apache2
      apt:
        name: apache2
        state: latest

    - name: install php-mysqli
      apt:
        name: php-mysqli
        state: latest
      notify:
        - restart apache2

    - name: install mariadb-server
      apt:
        name: mariadb-server
        state: latest

    - name: install git
      apt:
        name: git
        state: latest

    - name: install pip3
      apt:
        name: python3-pip
        state: latest

    - name: Remove index.html
      ansible.builtin.file:
        path: /var/www/html/index.html
        state: absent

    - name: Remove existing directory
      ansible.builtin.file:
        path: /var/www/html
        state: absent

    - name: Clone the shop
      ansible.builtin.git:
        repo: https://github.com/7ric/Photoblog.git
        dest: /var/www/html/
        update: no

    - name: Make sure pymysql is present
      become: true  # needed if the other tasks are not played as root
      pip:
        name: pymysql
        state: present

    - name: Create new databases photoshop
      community.mysql.mysql_db:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        state: import
        target: /var/www/html/photoblog.sql
        name: all
      ignore_errors: true

    - name: Change file permission
      file:
        path: /var/www/html/
        owner: www-data
        group: www-data
        recurse: true

    - name: display_errors
      lineinfile:
        dest: /etc/php/7.4/apache2/php.ini
        regexp: '^display_errors = Off'
        line: "display_errors = On"
        state: present
        backup: yes

    - name: disable_functions
      lineinfile:
        dest: /etc/php/7.4/apache2/php.ini
        regexp: '^disable_functions'
        line: "; disable_functions"
        state: present
        backup: yes
      notify:
        - restart apache2

  handlers:
    - name: restart ssh
      systemd:
        name: sshd
        state: restarted

    - name: restart apache2
      systemd:
        name: apache2
        state: restarted
